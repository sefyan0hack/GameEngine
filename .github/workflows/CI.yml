name: CI
on: [push, pull_request, workflow_dispatch]

jobs:
  Build:
    name: "${{ matrix.os }} x ${{ matrix.compiler }} x ${{ matrix.build_type }}"
    if: "!contains(github.event.head_commit.message, '[skip CI]') && !contains(github.event.head_commit.message, '[skip desk]')"
    runs-on: ${{ matrix.os }}
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, windows-11-arm, ubuntu-latest,  ubuntu-24.04-arm]
        compiler: [llvm, gcc, msvc]
        build_type: [Debug, Release]
        exclude:
          - os: ubuntu-latest
            compiler: msvc
          - os: ubuntu-24.04-arm
            compiler: msvc
          - os: windows-11-arm
            compiler: gcc

    env:
      TEST_TIMEOUT: 60
      BUILD_DIR: build/${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}
      APP_EXT: ${{ contains(matrix.os, 'windows' ) && '.exe' || '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == *ubuntu* ]]; then
            sudo apt-get install -y libx11-dev libgl-dev xvfb
          fi

      - name: Build Project
        uses: ./.github/actions/build
        with:
          os: ${{ matrix.os }}
          compiler: ${{ matrix.compiler }}
          build_type: ${{ matrix.build_type }}
          build_dir: ${{ env.BUILD_DIR }}
          cmake_flags: "-DTESTS=ON -DHARDEN=ON"

      - name: Upload Test Executable
        uses: actions/upload-artifact@v4
        with:
          name: unit_tests-${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}
          path: ${{ env.BUILD_DIR }}/tests/unit/unit_tests${{ env.APP_EXT }}
          retention-days: 1
          overwrite: true

      - name: Test
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == *ubuntu* ]]; then
            xvfb-run --auto-servernum ctest --test-dir "${{ env.BUILD_DIR }}" --output-on-failure --timeout ${{ env.TEST_TIMEOUT }}
          else
            ctest --test-dir "${{ env.BUILD_DIR }}" --output-on-failure --timeout ${{ env.TEST_TIMEOUT }}
          fi

  Build-Web:
    if: "!contains(github.event.head_commit.message, '[skip CI]') && !contains(github.event.head_commit.message, '[skip web]')"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      shell: bash
      run: sudo apt-get install -y libx11-dev libgl-dev

    - name: Build
      uses: ./.github/actions/emscripten-build
      with:
        cmake_configure_flags: "-DTESTS=ON"

    - name: Upload Test Executable
      uses: actions/upload-artifact@v4
      with:
        name: unit_tests-web
        path: |
          build/tests/**/*.js
          build/tests/**/*.html
          build/tests/**/*.wasm
          build/tests/**/*.data
        retention-days: 1
        overwrite: true

  Build-android:
    if: "!contains(github.event.head_commit.message, '[skip CI]') && !contains(github.event.head_commit.message, '[skip android]')"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ninja
        run: sudo apt-get install ninja-build

      - name: set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle 8.7
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 8.7

      - name: Configure Environment
        run: |
          # root directory of CMake, not the /bin folder.
          SYS_CMAKE=$(which cmake | xargs dirname | xargs dirname)
          echo "cmake.dir=$SYS_CMAKE" > android/local.properties
          echo "ndk.dir=$ANDROID_NDK_LATEST_HOME" >> android/local.properties

      - name: Build Debug APK
        working-directory: ./android
        run: gradle assembleDebug


      # --- Start an Android emulator (reactivecircus action installs SDK/emulator)
      - name: Start Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 21                # change to the API level you want
          target: google_apis          # or default; change if you prefer
          arch: x86_64
          force-avd-creation: true
          emulator-options: -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect
          script: |
            set -e

            mkdir -p ci-crash-logs

            echo "=== Devices ==="
            adb devices

            echo "=== Installing APK ==="
            adb install -r android/app/build/outputs/apk/debug/*.apk || true

            echo "=== Start logcat capture ==="
            adb logcat -v time > ci-crash-logs/logcat-live.log 2>&1 &
            LOGCAT_PID=$!

            PACKAGE="com.example.myapp"
            ACTIVITY="com.example.myapp.MainActivity"

            echo "=== Launching app ==="
            adb shell am start -W -n "$PACKAGE/$ACTIVITY" || true

            echo "=== Let app run ==="
            sleep 30

            echo "=== Dump logcat ==="
            adb logcat -d -v time > ci-crash-logs/logcat-dump.log || true

            echo "=== Pull tombstones ==="
            mkdir -p ci-crash-logs/tombstones
            adb shell ls /data/tombstones >/dev/null 2>&1 && \
              adb pull /data/tombstones ci-crash-logs/tombstones || true

            echo "=== Pull ANR traces ==="
            adb pull /data/anr/traces.txt ci-crash-logs/traces.txt || true

            echo "=== Stop logcat ==="
            kill -INT $LOGCAT_PID || true

      # --- Wait a little for adb to be ready (safety)
      - name: Wait for emulator to boot
        run: |
          adb wait-for-device
          # loop until boot completed
          for i in {1..60}; do
            BOOTED=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            if [ "$BOOTED" = "1" ]; then
              echo "Emulator booted"
              break
            fi
            echo "Waiting for boot... ($i)"
            sleep 2
          done

      # --- Install the debug APK(s)
      - name: Install APK(s)
        run: |
          APK_GLOB="android/app/build/outputs/apk/debug/*.apk"
          ls -l $APK_GLOB || true
          for apk in $APK_GLOB; do
            echo "Installing $apk"
            adb install -r "$apk" || true
          done

      # --- Start a background logcat to capture live logs while we exercise the app
      - name: Start background logcat capture
        run: |
          mkdir -p ci-crash-logs
          # rotate by size or just stream to file; killed at the end
          adb logcat -v time > ci-crash-logs/logcat-live.log 2>&1 &
          echo $! > ci-crash-logs/logcat.pid

      # --- Launch the app (replace PACKAGE/ACTIVITY below) or run tests/monkey
      - name: Launch app & exercise
        run: |
          # Replace these with your actual package/activity:
          PACKAGE="com.example.myapp"
          ACTIVITY="com.example.myapp.MainActivity"
          # If you don't know the package name, you can extract it from the APK using aapt:
          # aapt dump badging android/app/build/outputs/apk/debug/app-debug.apk | awk -F"'" '/package: name=/ {print $2}'
          echo "Starting $PACKAGE/$ACTIVITY"
          adb shell am start -W -n "$PACKAGE/$ACTIVITY" || true

          # Option A: allow the app to run for 30s and hope it crashes, or run UI tests.
          sleep 30

          # Option B (stress): run monkey for a little while to trigger crashes (uncomment if desired)
          # adb shell monkey -p "$PACKAGE" -v 500

      - name: Pull crash artifacts from device
        run: |
          mkdir -p ci-crash-logs
          # dump full logcat
          adb logcat -d -v time > ci-crash-logs/logcat-dump.log || true

          # pull tombstones (native crash dumps) from emulator if any
          mkdir -p ci-crash-logs/tombstones
          # emulator allows reading /data/tombstones
          if adb shell ls /data/tombstones >/dev/null 2>&1; then
            for f in $(adb shell ls /data/tombstones | tr -d '\r'); do
              adb pull "/data/tombstones/$f" "ci-crash-logs/tombstones/$f" || true
            done
          fi

          # pull ANR traces
          adb pull /data/anr/traces.txt ci-crash-logs/traces.txt || true

          # capture `dmesg` (may require root)
          adb shell dmesg > ci-crash-logs/dmesg.txt || true

          # store the live logcat PID and then kill the background logcat
          if [ -f ci-crash-logs/logcat.pid ]; then
            kill -INT $(cat ci-crash-logs/logcat.pid) || true
          fi

      - name: (Optional) Install NDK for symbolication
        if: always()
        run: |
          # install a specific NDK version with sdkmanager (requires commandlinetools installed by emulator-runner)
          yes | sdkmanager --install "ndk;25.2.9519653" || true
          NDK_DIR=$(ls -d $ANDROID_SDK_ROOT/ndk/* | sort -V | tail -n1)
          echo "NDK_DIR=$NDK_DIR"
          export ANDROID_NDK_HOME="$NDK_DIR"
          # Example: symbolize each tombstone using ndk-stack (you must point -sym to the unstripped obj or .so debug symbol dir)
          mkdir -p ci-crash-logs/symbolicated
          for tb in ci-crash-logs/tombstones/*; do
            [ -e "$tb" ] || continue
            # you MUST supply the path where your unstripped native libs or obj files live.
            # Example symbol dir: android/app/build/intermediates/cmake/debug/obj (update to your project layout)
            SYM_DIR="android/app/build/intermediates/cmake/debug/obj"
            if [ -x "${ANDROID_NDK_HOME}/ndk-stack" ]; then
              ${ANDROID_NDK_HOME}/ndk-stack -sym "$SYM_DIR" -dump "$tb" > "ci-crash-logs/symbolicated/$(basename $tb).txt" || true
            fi
          done

      # --- Upload artifacts: APK + logs + tombstones + symbolicated output
      - name: Upload APK and crash artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Launcher-Debug-APK-and-logs
          path: |
            android/app/build/outputs/apk/debug/*.apk
            ci-crash-logs/**
          retention-days: 1
          overwrite: true