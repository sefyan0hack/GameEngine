name: Include What You Use
on:
  workflow_dispatch: 

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install IWYU
        run: sudo apt-get install -y iwyu

      - name: Generate compilation database
        run: cmake -S . -B build -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_C_COMPILER=clang

      - name: Run Include What You Use
        run: |
          iwyu_tool -p build > iwyu_report.txt || true
          cat iwyu_report.txt

          # Make the build fail if there are suggestions
          if grep -q "should add these lines" iwyu_report.txt; then
            echo "IWYU found issues!"
            exit 1
          fi