name: Build MinGW-w64 GCC (fetch-only or full)

on:
  workflow_dispatch:
    inputs:
      full_build:
        description: 'Set "true" to perform a full GCC build (very long). Default = false (fetch-only).'
        required: false
        default: 'false'

jobs:
  build-mingw:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2 (MINGW64)
        id: msys
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          # install small helpers; adjust as needed
          install: git wget tar make bzip2 xz unzip

      - name: Clone mingw-builds
        run: |
          git clone https://github.com/niXman/mingw-builds.git
          ls -la mingw-builds/scripts

      - name: Make build script executable
        run: |
          chmod +x mingw-builds/scripts/gcc-trunk.sh

      - name: Fetch sources only (fast)
        if: ${{ github.event.inputs.full_build != 'true' }}
        run: |
          cd mingw-builds
          ./build --mode=gcc-trunk --arch=x86_64 --buildroot="$GITHUB_WORKSPACE/mingw_build" --fetch-only --update-sources

      - name: Full build (VERY long; only on manual dispatch)
        if: ${{ github.event.inputs.full_build == 'true' }}
        run: |
          cd mingw-builds
          # example options â€” tune these for your needs (languages, exceptions, threads)
          ./build --mode=gcc-trunk --arch=x86_64 \
                  --buildroot="$GITHUB_WORKSPACE/mingw_build" \
                  --enable-languages=c,c++ \
                  --threads=posix \
                  --exceptions=seh \
                  --no-strip

      - name: Upload built compiler / prefix as artifact
        uses: actions/upload-artifact@v4
        with:
          name: mingw-gcc
          path: mingw_build/**/prefix/**
