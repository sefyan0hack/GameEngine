name: Fetch MinGW-w64 sources (fetch-only)

on:
  workflow_dispatch:

jobs:
  fetch-mingw:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: git wget tar make bzip2 xz unzip zip

      - name: Clone mingw-builds
        run: |
          git clone https://github.com/niXman/mingw-builds.git
          ls -la mingw-builds/scripts

      - name: Make build script executable
        run: |
          chmod +x mingw-builds/scripts/gcc-trunk.sh

      - name: Fetch sources only (fast)
        run: |
          cd mingw-builds
          ./build --mode=gcc-trunk --arch=x86_64 \
                  --buildroot="$GITHUB_WORKSPACE/mingw_build" \
                  --fetch-only --update-sources

      - name: Inspect buildroot (debug)
        run: |
          echo "PWD: $(pwd)"
          echo "List top-level:"
          ls -la
          echo "List mingw_build (if exists):"
          ls -la mingw_build || true
          echo
          echo "Find any 'prefix' directories (maxdepth 6):"
          find mingw_build -maxdepth 6 -type d -name prefix -print || true

      - name: Package fetched sources
        run: |
          set -e
          if [ -d mingw_build ]; then
            echo "Packaging mingw_build -> mingw-buildroot.zip"
            zip -r mingw-buildroot.zip mingw_build
          else
            echo "No mingw_build directory found; packaging mingw-builds repo instead"
            zip -r mingw-builds.zip mingw-builds || true
          fi

      - name: Upload fetched sources artifact
        uses: actions/upload-artifact@v4
        with:
          name: mingw-fetched-sources
          path: |
            mingw-buildroot.zip
            mingw-builds.zip
