name: Emscripten Build

on:
  workflow_call:
    inputs:
      emsdk_version:
        required: false
        type: string
        default: "4.0.10"
      system_dependencies:
        required: false
        type: string
        default: ""
      cmake_configure_flags:
        required: false
        type: string
        default: ""
      build_dir:
        required: false
        type: string
        default: "build-web"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      EMSDK_VERSION: ${{ inputs.emsdk_version }}
      BUILD_DIR: ${{ inputs.build_dir }}

    steps:
      - uses: actions/checkout@v3

      - name: Set EMSDK path
        run: echo "EMSDK_PATH=$HOME/emsdk" >> $GITHUB_ENV

      - name: Cache emsdk
        uses: actions/cache@v3
        with:
          path: ${{ env.EMSDK_PATH }}
          key: emsdk-${{ runner.os }}-${{ env.EMSDK_VERSION }}

      - uses: mymindstorm/setup-emsdk@v14
        with:
          version: ${{ env.EMSDK_VERSION }}

      - name: Verify Emscripten
        run: emcc -v

      - name: Cache apt packages
        uses: actions/cache@v3
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-${{ hashFiles('.github/workflows/**/*.yml') }}

      - name: Install Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends ${{ inputs.system_dependencies }}

      - name: Configure
        run: emcmake cmake -S . -B "${{ env.BUILD_DIR }}" -G Ninja ${{ inputs.cmake_configure_flags }}

      - name: Build
        run: cmake --build "${{ env.BUILD_DIR }}"